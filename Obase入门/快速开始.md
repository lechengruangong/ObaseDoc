欢迎使用Obase!

Obase是一款存储抽象层框架中间件,致力于为大家带来统一的存储抽象层,使得开发者可以更专注于逻辑的实现,而不必过多关注底层存储的细节.

我们将会使用一个渐进的示例来为大家讲解Obase的使用.

## dotNet版

我现在有一个简单的博客系统,我使用MySql作为数据源,有一个文章表(Article),其中有一些字段(比如Code,Title之类的).
我为这个表定义了对应的数据模型类
```
/// <summary>
///     博客文章
/// </summary>
public class Article
{
    /// <summary>
    ///     Code 文章代码
    /// </summary>
    public string Code { get; set; }

    /// <summary>
    ///     Title 文章标题
    /// </summary>
    public string Title { get; set; }
}
```
我现在要怎么使用Obase来通过数据模型类操作数据库?

### 安装Obase

首先,要安装Obase,在项目中引入如下的引用:
```
<PackageReference Include="Obase.Providers.MySql" Version="6.4.2" />
```
此处引用的是Obase的MySql提供程序的6.4.2版本,因为之前提到使用的数据源是MySql,如果需要连接其他的数据源,请参考[Obase连接兼容的Sql数据源](../Obase基础知识/Obase连接兼容的Sql数据源.md).
此处的版本号实际使用时根据需要来确定,一般选择最新版即可,具体的修改记录可在[Obase修改记录](https://github.com/lechengruangong/Obase4DotNet/releases)里查看.

### 定义上下文和上下文配置提供者

我们需要定义上下文和上下文配置提供者,其中上下文继承需要ObjectContext上下文配置提供者需要继承MySqlContextConfigProvider(此处继承MySqlContextConfigProvider是因为数据源为MySql,更多信息请参考[Obase连接兼容的Sql数据源](../Obase基础知识/Obase连接兼容的Sql数据源.md)).

```
/// <summary>
///     示例上下文
/// </summary>
public class SampleContext : ObjectContext
{
    /// <summary>构造ObjectContext对象</summary>
    public SampleContext() : base(new SampleContextConfiguration())
    {
    }
}

/// <summary>
///     示例上下文配置
/// </summary>
public class SampleContextConfiguration : MySqlContextConfigProvider
{
    /// <summary>使用指定的建模器创建对象数据模型。</summary>
    /// <param name="modelBuilder">对象数据模型建造器</param>
    protected override void CreateModel(ModelBuilder modelBuilder)
    {
         //对Article数据模型类进行配置
         var articleEntity = modelBuilder.Entity<Article>();
         //配置主键映射 和 主键是否自增
         articleEntity.HasKeyAttribute(p => p.Code).HasKeyIsSelfIncreased(false);
         //配置映射表
         articleEntity.ToTable("Article");
    }

    /// <summary>由派生类实现，获取数据库连接字符串。</summary>
    protected override string ConnectionString => "这里放置数据库连接字符串";
}
```

上下文的构造函数需要提供一个ContextConfigProvider类型的参数,此处使用的是继承MySqlContextConfigProvider的SampleContextConfiguration.
在上下文配置提供者SampleContextConfiguration中,需要重写一个属性访问器ConnectionString和方法CreateModel(ModelBuilder modelBuilder).

属性访问器ConnectionString只需要返回所使用的数据库连接字符串即可.

方法CreateModel(ModelBuilder modelBuilder)则需要配置Article的映射关系,首先将Article类注册为Entity,然后设置Article的主键和主键是否自增,最后配置Article在数据库所存储的表.

这里其实还需要配置Code和Title这些属性,但这些属性是Obase的基元类型,只需要使用默认配置即可,故在此处未进行配置.

在之后的[深入理解](./深入理解.md)这一篇中会对配置进行深入的介绍.

然后,就可以开始使用Obase来通过数据模型类操作数据库了.

### 新增对象

新增对象只需要构造一个Article对象,然后使用上下文Attach这个对象,之后使用上下文SaveChanges即可.
```
//构造上下文对象
var context = new SampleContext();
//构造一篇文章
var article = new Article
{
    Code = "A0001",
    Title = "标题"
};
//将文章附加值上下文
context.Attach(article);
//保存更改至数据库
context.SaveChanges();
```
在执行SaveChanges方法后,Article即保存至数据库内了.

### 查询对象

查询对象需要使用上下文的CreateSet方法获取对象集,然后在对象集上使用Linq方法即可.
```
//查询Article表内第一条数据
var article = context.CreateSet<Article>().FirstOrDefault();
```
如果要执行筛选之类的操作,只需要调用Where等方法即可.
```
//查询Article表内Code == "A0001" 跳过 0 个 提取 1 个的所有数据
var articles = context.CreateSet<Article>().Where(p => p.Code == "A0001").Skip(0).Take(1).ToList();
```
对象集可以看做数据源中某张表的代理,Linq操作会被映射为Sql查询.

### 修改对象

修改对象首先需要查询出对象,然后修改对象的属性,之后使用上下文SaveChanges即可.

```
//查询对象
var article = context.CreateSet<Article>().FirstOrDefault(p => p.Code == "A0001");
//修改标题
article.Title = "新标题";
//保存更改至数据库
context.SaveChanges();
```

Obase会把侦测SaveChanges调用之前未保存的改动持久化至数据源内.

### 删除对象

删除对象首先需要查询出对象,然后调用上下文的Remove方法,之后使用上下文SaveChanges即可.

```
//查询对象
var article = context.CreateSet<Article>().FirstOrDefault(p => p.Code == "A0001");
//标记删除
context.Remove(article);
//保存更改至数据库
context.SaveChanges();
```

### Tips
这里所查询对象,修改对象,删除对象等节中使用的上下文都是在新增对象时初始化的,关于更多的Obase上下文管理的参考,请阅读[Obase的上下文管理](../Obase基础知识/Obase的上下文管理.md).