对于调用者而言,Obase的对象数据模型是居于核心地位的,Obase需要根据对象数据模型来进行对象管理,查询等操作,本篇介绍Obase的对象数据模型的建造流程以方便大家理解对象数据模型建模.

首先,Obase的对象数据模型的建造是一个较重的过程,此过程会根据你的配置和推断规则来建立对象数据模型,所以对于某个确定的上下文,他的对象数据模型只有一份,以上下文类型为键保存在一个单例中.

其次,为了保证模型的多线程性能,模型中使用了较多的读写锁,这些锁在多读很少写的场景下有近乎无锁的性能,但在建造模型时会通过写锁来限制多线程,所以最好只在单线程中对模型进行建造.

最后,Obase的对象数据模型的建造支持扩展,详细内容可以参考[Obase如何扩展建模管道](../Obase进阶使用/Obase如何扩展建模管道.md),此下内容会提到在默认管道情况下指的都是当前建模管道中只有默认管道节点的情形.

接下来开始介绍建模流程:

1. 处理忽略对象
   1. 循环忽略列表,已注册类型中与忽略列表中类型相同的一处
2. 生成建模管道
    1. 使用忽略列表构造默认的类型解析器
    2. 使用默认的代理类型解析器,默认的类型解析器,默认的类型成员解析器,默认的补充配置解析器构造默认管道.
    3. 检查四个默认管道,如果有重复的管道节点抛出异常.
3. 创建隐式关联配置器
    1. 循环所有类型配置,在实体型上进行隐式关联配置推断.
    2. 循环实体型的属性,跳过被忽略的属性,继承的属性,找到已被配置为实体型类型的属性.
    3. 根据当前实体型类型和属性的类型查找是否已被配置为隐式关联型,如果没有配置则推断为隐式关联型.
    4. 创建相应的隐式关联型配置.
4. 生成隐式关联
    1. 循环所有的隐式关联型配置,建造隐式关联型配置.
    2. 生成隐式关联型的类型和对应的隐式关联型配置,生成关联端配置.
    3. 将生成的配置加入类型配置字典.
5. 排序
    1. 将实体型配置放置于关联型配置之前.
    2. 将继承的配置中,父类的配置放置于子类的配置之前.
6. 创建结构化类型配置
    1. 使用默认的类型解析管道解析当前所有注册的类型.
    2. 查找无参的构造函数推断为类型的构造器,如果没有符合条件的构造函数且未配置构造器则抛出异常.
    3. 将类型名称推断为实体类型的映射表,根据引用的多重性推断关联的映射表.
    4. 推断实体型的主键.
    5. 根据配置创建结构化类型,将结构化类型加入对象数据模型.
7. 创建类型元素配置
    1. 使用默认的类型成员解析管道解析当前所有注册的类型.
    2. 将Obase的基元类型属性推断为属性配置,并配置取值器,设值器和映射字段.
    3. 将已注册实体型和显式关联型属性推断为引用元素配置,并配置取值器,设值器.
    4. 根据配置创建类型元素配置,并在所属的结构化类上设置类型元素.
8. 处理继承关系
    1. 使用字典存储当前类的继承关系中的父类和当前类的对应关系.
    2. 检查当前类继承的父类的类型判别字段是否与当前类相同.
9. 处理代理类型
    1. 使用默认的代理类型解析管道解析当前所有注册的类型.
    2. 为配置了启用延迟加载的引用元素的类,没有定义外键属性,没有定义类型判别属性的类定义代理类型.
10. 处理具体类型判别器
    1. 为继承关系中的父类设置具体类型判别器.
    2. 生成一个抽象构造器作为父类的构造器,将原有的构造器保存至基类型构造器.
11. 处理补充配置
    1. 使用默认的补充配置解析器解析当前所有注册的类型.
    2. 补充关联引用的左端和右端配置,为继承关系中的父类增加用于查询子类的虚拟属性.
12. 处理完整性检查
    1. 如果_integrityCheck是true,则进行完整性检查.
    2. 更多的完整性检查相关内容,请参考[Obase的完整性检查](./Obase的完整性检查.md).
13. 处理结构映射
    1. 如果启用了结构映射,则进行结构映射.
    2. 更多的结构映射相关内容,请参考[Obase的结构映射](./Obase的结构映射.md).